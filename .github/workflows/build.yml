# JustGlow - GitHub Actions Build Workflow
# Builds the After Effects plugin for Windows and macOS

name: Build JustGlow

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Manual trigger

env:
  BUILD_TYPE: Release

jobs:
  # ============================================
  # Windows Build
  # ============================================
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Setup CMake
      uses: lukka/get-cmake@latest

    # Install CUDA Toolkit
    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.22
      id: cuda-toolkit
      with:
        cuda: '12.6.0'
        method: 'network'
        sub-packages: '["nvcc", "cudart"]'

    - name: Verify CUDA Installation
      run: |
        echo "CUDA path: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
        nvcc --version
      shell: pwsh

    # Download and extract After Effects SDK
    - name: Download AE SDK
      run: |
        # Check if SDK already exists
        if (Test-Path "include/AE_SDK/AE_Effect.h") {
          Write-Host "AE SDK already present"
          exit 0
        }

        Write-Host "::warning::AE SDK not found. Please add SDK to repository."
        Write-Host "Expected location: include/AE_SDK/"

        # Create placeholder if not exists
        New-Item -ItemType Directory -Force -Path "include/AE_SDK" | Out-Null
      shell: pwsh

    # Find DXC
    - name: Find DirectX Shader Compiler
      id: find-dxc
      run: |
        $windowsKits = "C:\Program Files (x86)\Windows Kits\10\bin"
        $latestVersion = Get-ChildItem $windowsKits -Directory |
          Where-Object { $_.Name -match '^\d+\.\d+\.\d+\.\d+$' } |
          Sort-Object Name -Descending |
          Select-Object -First 1
        $dxcPath = Join-Path $latestVersion.FullName "x64\dxc.exe"
        echo "DXC_PATH=$dxcPath" >> $env:GITHUB_OUTPUT
        echo "Found DXC at: $dxcPath"
      shell: pwsh

    # Download PiPLtool if not present
    - name: Setup PiPLtool
      run: |
        $piplToolDir = "tools"
        $piplTool = "$piplToolDir/PiPLtool.exe"

        if (-not (Test-Path $piplTool)) {
          New-Item -ItemType Directory -Force -Path $piplToolDir | Out-Null
          Write-Host "::warning::PiPLtool.exe not found at $piplTool"
          Write-Host "Please add PiPLtool.exe from AE SDK to tools/ folder"
        } else {
          Write-Host "PiPLtool found at: $piplTool"
        }

        echo "PIPL_TOOL=${{ github.workspace }}/$piplTool" >> $env:GITHUB_OUTPUT
      shell: pwsh
      id: pipl-tool

    # Configure CMake
    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
          -DAE_SDK_PATH="${{ github.workspace }}/include/AE_SDK" `
          -DPIPL_TOOL="${{ steps.pipl-tool.outputs.PIPL_TOOL }}" `
          -DENABLE_CUDA=ON `
          -DCUDAToolkit_ROOT="${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
      shell: pwsh

    # Build
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

    # Compile Shaders
    - name: Compile Shaders
      run: |
        $dxc = "${{ steps.find-dxc.outputs.DXC_PATH }}"
        $shaderDir = "shaders"
        $outputDir = "build/${{ env.BUILD_TYPE }}/DirectX_Assets"

        New-Item -ItemType Directory -Force -Path $outputDir

        $shaders = @(
          @{Name="Prefilter"; Entry="main"},
          @{Name="Downsample"; Entry="main"},
          @{Name="Upsample"; Entry="main"},
          @{Name="PostProcess"; Entry="main_anamorphic"},
          @{Name="Composite"; Entry="main"}
        )

        foreach ($shader in $shaders) {
          $input = "$shaderDir/$($shader.Name).hlsl"
          $output = "$outputDir/$($shader.Name).cso"

          if (Test-Path $input) {
            Write-Host "Compiling $($shader.Name).hlsl..."
            & $dxc -T cs_6_0 -E $($shader.Entry) -Fo $output -I $shaderDir $input
          }
        }
      shell: pwsh
      continue-on-error: true

    # Package
    - name: Package Plugin
      run: |
        $version = (Select-String -Path "CMakeLists.txt" -Pattern 'VERSION (\d+\.\d+\.\d+)').Matches.Groups[1].Value
        $artifactDir = "artifacts/JustGlow-Windows"

        New-Item -ItemType Directory -Force -Path $artifactDir

        # Find and copy plugin (with version in name)
        Get-ChildItem "build/${{ env.BUILD_TYPE }}" -Filter "*.aex" | ForEach-Object {
          Copy-Item $_.FullName "$artifactDir/"
          Write-Host "Copied: $($_.Name)"
        }

        # Copy shaders
        if (Test-Path "build/${{ env.BUILD_TYPE }}/DirectX_Assets") {
          Copy-Item -Recurse "build/${{ env.BUILD_TYPE }}/DirectX_Assets" "$artifactDir/"
        }

        # Copy CUDA PTX files
        if (Test-Path "build/CUDA_Assets") {
          Copy-Item -Recurse "build/CUDA_Assets" "$artifactDir/"
          Write-Host "Copied CUDA_Assets"
        }
      shell: pwsh

    # Upload
    - name: Upload Windows Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JustGlow-Windows-x64
        path: artifacts/JustGlow-Windows/
        retention-days: 30

  # ============================================
  # macOS Build
  # ============================================
  build-macos:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup CMake
      run: brew install cmake

    # Check AE SDK
    - name: Check AE SDK
      run: |
        if [ -f "include/AE_SDK/AE_Effect.h" ]; then
          echo "AE SDK found"
        else
          echo "::warning::AE SDK not found. Please add SDK to repository."
          mkdir -p include/AE_SDK
        fi

    # Configure CMake
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
          -DCMAKE_OSX_ARCHITECTURES="x86_64;arm64" \
          -DAE_SDK_PATH="${{ github.workspace }}/include/AE_SDK"

    # Build
    - name: Build
      run: cmake --build build --config ${{ env.BUILD_TYPE }} --parallel
      continue-on-error: true  # macOS build may fail without full setup

    # Package
    - name: Package Plugin
      run: |
        mkdir -p artifacts/JustGlow-macOS

        # Copy plugin bundle if exists
        if [ -d "build/JustGlow.plugin" ]; then
          cp -R "build/JustGlow.plugin" "artifacts/JustGlow-macOS/"
        elif [ -d "build/${{ env.BUILD_TYPE }}/JustGlow.plugin" ]; then
          cp -R "build/${{ env.BUILD_TYPE }}/JustGlow.plugin" "artifacts/JustGlow-macOS/"
        fi
      continue-on-error: true

    # Upload
    - name: Upload macOS Artifact
      uses: actions/upload-artifact@v4
      with:
        name: JustGlow-macOS-Universal
        path: artifacts/JustGlow-macOS/
        retention-days: 30
      if: always()

  # ============================================
  # Create Release (on tag)
  # ============================================
  release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: JustGlow-Windows-x64
        path: release/windows

    - name: Download macOS artifact
      uses: actions/download-artifact@v4
      with:
        name: JustGlow-macOS-Universal
        path: release/macos
      continue-on-error: true

    - name: Create Release Archives
      run: |
        cd release
        zip -r ../JustGlow-${{ github.ref_name }}-Windows-x64.zip windows/
        if [ -d "macos" ] && [ "$(ls -A macos)" ]; then
          zip -r ../JustGlow-${{ github.ref_name }}-macOS-Universal.zip macos/
        fi

    - name: Upload Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          JustGlow-*.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
