<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JustGlow - Alpha Calculation Detail</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 40px;
            margin: 0;
        }
        h1 { color: #4fc3f7; text-align: center; }
        h2 {
            color: #81c784;
            margin-top: 40px;
            border-bottom: 2px solid #81c784;
            padding-bottom: 10px;
        }
        h3 { color: #ffb74d; margin-top: 30px; }
        .mermaid {
            background: #252542;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .code-block {
            background: #1e1e3f;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .highlight { color: #4fc3f7; }
        .comment { color: #6a9955; }
        .number { color: #b5cea8; }
        .issue {
            background: rgba(255,82,82,0.2);
            border-left: 4px solid #ff5252;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .note {
            background: rgba(33,150,243,0.2);
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success {
            background: rgba(76,175,80,0.2);
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #444;
            padding: 10px;
            text-align: left;
        }
        th { background: #333; }
    </style>
</head>
<body>
    <h1>Alpha Calculation Flow</h1>

    <h2>1. ì „ì²´ ì•ŒíŒŒ íë¦„</h2>
    <div class="mermaid">
flowchart TB
    subgraph INPUT["ì…ë ¥ (AE Premultiplied)"]
        I1["input RGBA<br/>(premultiplied)"]
    end

    subgraph PREFILTER["Prefilter"]
        P1["13-tap ZeroPad Sampling"]
        P2["Weighted Average<br/>sumA = Î£(Ai Ã— wi)"]
        P3["Alpha ê·¸ëŒ€ë¡œ ì „ë‹¬"]
        P4["softThreshold(RGBë§Œ)"]
    end

    subgraph DOWNSAMPLE["Downsample Chain"]
        D1["2D Gaussian ë¸”ëŸ¬"]
        D2["Alphaë„ í•¨ê»˜ ë¸”ëŸ¬ë¨"]
        D3["m_mipChain[0..N]"]
    end

    subgraph UPSAMPLE["Upsample Chain"]
        U1["9-tap Tent Upsample"]
        U2["Alpha ë¸”ëŸ¬ ëˆ„ì "]
        U3["m_upsampleChain[0]<br/>(ìµœì¢… Glow)"]
    end

    subgraph COMPOSITE["Composite"]
        C1["sampleBilinear(glow)"]
        C2["glowR, glowG, glowB, glowA"]
        C3["âš ï¸ glowAlpha ì¬ê³„ì‚°!<br/>max(R, G, B)"]
        C4["Blend Mode ì ìš©"]
        C5["resA = srcA + glowAlpha"]
    end

    I1 --> P1 --> P2 --> P3 --> P4
    P4 --> D1 --> D2 --> D3
    D3 --> U1 --> U2 --> U3
    U3 --> C1 --> C2 --> C3 --> C4 --> C5

    style C3 fill:#ff5252
    </div>

    <h2>2. Prefilter ì•ŒíŒŒ ì²˜ë¦¬</h2>
    <div class="mermaid">
flowchart LR
    subgraph SAMPLE["13-tap Sampling"]
        S1["sampleBilinearZeroPad()"]
        S2["13ê°œ ìƒ˜í”Œ Ã— RGBA"]
        S3["ê²½ê³„ ë°– = (0,0,0,0)"]
    end

    subgraph AVERAGE["Weighted Average"]
        A1["sumA = GaÃ—wCenter +<br/>(Da+Ea+Ia+Ja)Ã—wInner +<br/>(Ba+Fa+Ha+La)Ã—wCross +<br/>(Aa+Ca+Ka+Ma)Ã—wCorner"]
    end

    subgraph THRESHOLD["Soft Threshold"]
        T1["softThreshold(R,G,B)"]
        T2["AlphaëŠ” ë³€ê²½ ì•ˆí•¨!"]
    end

    subgraph OUTPUT["ì¶œë ¥"]
        O1["output = (resR, resG, resB, sumA)"]
    end

    S1 --> S2 --> S3 --> A1
    A1 --> T1 --> T2 --> O1

    style T2 fill:#4caf50
    </div>

    <div class="code-block">
<span class="comment">// Prefilter: Alpha weighted average (Line 438)</span>
<span class="highlight">float</span> sumA = Ga * wCenter + (Da + Ea + Ia + Ja) * wInner
           + (Ba + Fa + Ha + La) * wCross + (Aa + Ca + Ka + Ma) * wCorner;

<span class="comment">// Soft thresholdëŠ” RGBë§Œ (Line 479)</span>
softThreshold(resR, resG, resB, threshold, softKnee);

<span class="comment">// ì¶œë ¥: AlphaëŠ” sumA ê·¸ëŒ€ë¡œ</span>
output[outIdx + 3] = sumA;  <span class="comment">// âœ“ ì •ìƒ</span>
    </div>

    <h2>3. Composite ì•ŒíŒŒ ê³„ì‚° (ë¬¸ì œ ì§€ì )</h2>
    <div class="mermaid">
flowchart TB
    subgraph GLOW_SAMPLE["Glow ìƒ˜í”Œë§"]
        G1["sampleBilinear(glow, u, v, ...)"]
        G2["glowR, glowG, glowB, glowA"]
    end

    subgraph ALPHA_CALC["âš ï¸ Alpha ì¬ê³„ì‚°"]
        A1["glowA (ì‹¤ì œ ì•ŒíŒŒ) ì‚¬ìš© ì•ˆí•¨!"]
        A2["glowAlpha = max(R, G, B)"]
        A3["glowAlpha = min(max(R,G,B), 1.0)"]
    end

    subgraph BLEND["Blend Mode"]
        B1["Add: resA = srcA + glowAlpha"]
        B2["Screen: resA = srcA + glowAlpha - srcAÃ—glowAlpha"]
    end

    G1 --> G2
    G2 --> A1
    A1 --> A2 --> A3 --> B1
    A3 --> B2

    style A1 fill:#ff5252
    style A2 fill:#ff9800
    </div>

    <div class="code-block">
<span class="comment">// DebugOutputKernel (Line 1188-1189)</span>

<span class="comment">// glowAê°€ ìˆëŠ”ë° ì‚¬ìš© ì•ˆí•¨!</span>
<span class="highlight">float</span> glowR, glowG, glowB, glowA;
sampleBilinear(glow, u, v, glowWidth, glowHeight, glowPitch,
               glowR, glowG, glowB, <span style="color:#ff5252">glowA</span>);  <span class="comment">// glowA ì½ìŒ</span>

<span class="comment">// âš ï¸ ê·¸ëŸ°ë° glowA ëŒ€ì‹  RGBì—ì„œ ì¬ê³„ì‚°!</span>
<span class="highlight">float</span> glowAlpha = fminf(fmaxf(fmaxf(<span style="color:#ff9800">glowR, glowG</span>), <span style="color:#ff9800">glowB</span>), 1.0f);

<span class="comment">// ì´ glowAlphaê°€ ë¸”ë Œë“œì— ì‚¬ìš©ë¨</span>
resA = fminf(srcA + <span style="color:#ff9800">glowAlpha</span>, 1.0f);  <span class="comment">// Add mode</span>
    </div>

    <div class="issue">
        <strong>ğŸ”´ ë¬¸ì œ ë°œê²¬:</strong><br/><br/>
        <code>glowA</code>ëŠ” ì‹¤ì œë¡œ MIP ì²´ì¸ì„ í†µí•´ ë¸”ëŸ¬ëœ ì•ŒíŒŒ ì±„ë„ì¸ë°,<br/>
        Compositeì—ì„œ <code>glowA</code>ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  RGBì—ì„œ <code>max(R,G,B)</code>ë¡œ ì¬ê³„ì‚°!<br/><br/>
        <strong>ì™œ ë¬¸ì œì¸ê°€:</strong><br/>
        - í…ìŠ¤íŠ¸ ë ˆì´ì–´: ì‘ì€ ì†ŒìŠ¤ â†’ ë¸”ëŸ¬ ì—ë„ˆì§€ ì ìŒ â†’ glowR,G,B ë‚®ìŒ â†’ glowAlpha ë‚®ìŒ<br/>
        - ì¡°ì • ë ˆì´ì–´: í° ì†ŒìŠ¤ â†’ ë¸”ëŸ¬ ì—ë„ˆì§€ ë§ìŒ â†’ glowR,G,B ë†’ìŒ â†’ glowAlpha ë†’ìŒ
    </div>

    <h2>4. ì¡°ì • ë ˆì´ì–´ vs í…ìŠ¤íŠ¸ ë ˆì´ì–´ ë¹„êµ</h2>
    <div class="mermaid">
flowchart LR
    subgraph ADJ["ì¡°ì • ë ˆì´ì–´"]
        A1["Input: 1920Ã—1080<br/>(ì „ì²´ ë°ì€ í”½ì…€)"]
        A2["Glow RGB: ë†’ìŒ"]
        A3["glowAlpha = 0.8+"]
        A4["resA = ê°•í•¨"]
    end

    subgraph TEXT["í…ìŠ¤íŠ¸ ë ˆì´ì–´"]
        T1["Input: 237Ã—209<br/>(ì¼ë¶€ë§Œ ë°ìŒ)"]
        T2["Glow RGB: ë‚®ìŒ"]
        T3["glowAlpha = 0.2~0.5"]
        T4["resA = ì•½í•¨"]
    end

    A1 --> A2 --> A3 --> A4
    T1 --> T2 --> T3 --> T4

    style A4 fill:#4caf50
    style T4 fill:#ff5252
    </div>

    <table>
        <tr>
            <th>í•­ëª©</th>
            <th>ì¡°ì • ë ˆì´ì–´</th>
            <th>í…ìŠ¤íŠ¸ ë ˆì´ì–´</th>
        </tr>
        <tr>
            <td>ì…ë ¥ í¬ê¸°</td>
            <td>1920Ã—1080</td>
            <td>237Ã—209</td>
        </tr>
        <tr>
            <td>ë°ì€ í”½ì…€ ìˆ˜</td>
            <td>ë§ìŒ (ì „ì²´)</td>
            <td>ì ìŒ (í…ìŠ¤íŠ¸ë§Œ)</td>
        </tr>
        <tr>
            <td>Glow ë²„í¼ ì—ë„ˆì§€</td>
            <td>ë†’ìŒ</td>
            <td>ë‚®ìŒ</td>
        </tr>
        <tr>
            <td>max(R,G,B)</td>
            <td>~0.8+</td>
            <td>~0.2~0.5</td>
        </tr>
        <tr>
            <td style="color:#ff5252">glowAlpha ì¶”ì •ê°’</td>
            <td style="color:#4caf50">ê°•í•¨</td>
            <td style="color:#ff5252">ì•½í•¨</td>
        </tr>
    </table>

    <h2>5. ìˆ˜ì • ì œì•ˆ</h2>

    <h3>Option A: ì‹¤ì œ glowA ì‚¬ìš©</h3>
    <div class="code-block">
<span class="comment">// í˜„ì¬ (ë¬¸ì œ)</span>
<span class="highlight">float</span> glowAlpha = fminf(fmaxf(fmaxf(glowR, glowG), glowB), 1.0f);

<span class="comment">// ìˆ˜ì •: ì‹¤ì œ alpha ì±„ë„ ì‚¬ìš©</span>
<span class="highlight">float</span> glowAlpha = glowA;
    </div>

    <h3>Option B: RGB + Alpha í•˜ì´ë¸Œë¦¬ë“œ</h3>
    <div class="code-block">
<span class="comment">// RGB ê¸°ë°˜ ë°ê¸°ì™€ ì‹¤ì œ ì•ŒíŒŒ ì¤‘ í° ê°’</span>
<span class="highlight">float</span> rgbAlpha = fminf(fmaxf(fmaxf(glowR, glowG), glowB), 1.0f);
<span class="highlight">float</span> glowAlpha = fmaxf(rgbAlpha, glowA);
    </div>

    <h3>Option C: ì •ê·œí™”ëœ ì•ŒíŒŒ</h3>
    <div class="code-block">
<span class="comment">// ë²„í¼ í¬ê¸°ì— ê´€ê³„ì—†ì´ ì¼ì •í•œ ì•ŒíŒŒ ê°•ë„</span>
<span class="comment">// Glow ì—ë„ˆì§€ë¥¼ ì •ê·œí™”</span>
<span class="highlight">float</span> glowLum = (glowR + glowG + glowB) / 3.0f;
<span class="highlight">float</span> normalizedAlpha = fminf(glowLum * exposure * 2.0f, 1.0f);
<span class="highlight">float</span> glowAlpha = fmaxf(normalizedAlpha, glowA);
    </div>

    <h2>6. ì½”ë“œ ìœ„ì¹˜</h2>
    <div class="code-block">
<span class="comment">// JustGlowKernels.cu - DebugOutputKernel()</span>

<span class="comment">// Line 1165: Glow ìƒ˜í”Œë§</span>
sampleBilinear(glow, u, v, glowWidth, glowHeight, glowPitch,
               glowR, glowG, glowB, glowA);

<span class="comment">// Line 1188-1189: âš ï¸ Alpha ì¬ê³„ì‚° (ë¬¸ì œ)</span>
<span class="highlight">float</span> glowAlpha = fminf(fmaxf(fmaxf(glowR, glowG), glowB), 1.0f);

<span class="comment">// Line 1198: Add ë¸”ë Œë“œ</span>
resA = fminf(srcA + glowAlpha, 1.0f);

<span class="comment">// Line 1205: Screen ë¸”ë Œë“œ</span>
resA = srcA + glowAlpha - srcA * glowAlpha;
    </div>

    <h2>7. í…ŒìŠ¤íŠ¸ ë°©ë²•</h2>
    <div class="note">
        <strong>1. Debug View = Glow Only (16)ë¡œ ì„¤ì •</strong><br/>
        í…ìŠ¤íŠ¸ ë ˆì´ì–´ì™€ ì¡°ì • ë ˆì´ì–´ì—ì„œ ê¸€ë¡œìš° ë°ê¸° ë¹„êµ<br/><br/>

        <strong>2. ì•ŒíŒŒ ì±„ë„ë§Œ í™•ì¸</strong><br/>
        AEì—ì„œ ì•ŒíŒŒ ì±„ë„ í‘œì‹œ â†’ ê¸€ë¡œìš° ì•ŒíŒŒ ê°•ë„ ë¹„êµ<br/><br/>

        <strong>3. glowA vs max(R,G,B) ë¡œê·¸ ì¶”ê°€</strong><br/>
        <code>CUDA_LOG("glowA=%.3f, maxRGB=%.3f", glowA, maxRGB);</code>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
