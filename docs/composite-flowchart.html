<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JustGlow - Full Pipeline Flowchart</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 40px;
            margin: 0;
        }
        h1 { color: #4fc3f7; text-align: center; }
        h2 {
            color: #81c784;
            margin-top: 40px;
            border-bottom: 2px solid #81c784;
            padding-bottom: 10px;
        }
        h3 { color: #ffb74d; margin-top: 30px; }
        .mermaid {
            background: #252542;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .legend {
            background: rgba(255,255,255,0.05);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .legend-item { margin: 8px 0; }
        .code { color: #4fc3f7; font-family: monospace; }
        .file { color: #ffb74d; font-family: monospace; }
        .issue {
            background: rgba(255,82,82,0.2);
            border-left: 4px solid #ff5252;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .note {
            background: rgba(33,150,243,0.2);
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #444;
            padding: 10px;
            text-align: left;
        }
        th { background: #333; }
    </style>
</head>
<body>
    <h1>JustGlow - Full Rendering Pipeline</h1>

    <div class="legend">
        <strong>ë²”ë¡€:</strong>
        <div class="legend-item">ğŸŸ¦ íŒŒë€ìƒ‰ = ì…ë ¥ ë²„í¼ (Input Buffer)</div>
        <div class="legend-item">ğŸŸ© ì´ˆë¡ìƒ‰ = ì²˜ë¦¬ (Process)</div>
        <div class="legend-item">ğŸŸ§ ì£¼í™©ìƒ‰ = ì¶œë ¥ ë²„í¼ (Output Buffer)</div>
        <div class="legend-item">ğŸŸª ë³´ë¼ìƒ‰ = ì¡°ê±´/ë¶„ê¸° (Condition)</div>
        <div class="legend-item">ğŸŸ¥ ë¹¨ê°„ìƒ‰ = ì¤‘ê°„ ë²„í¼ (Intermediate Buffer)</div>
    </div>

    <h2>1. ì „ì²´ íŒŒì´í”„ë¼ì¸ ê°œìš”</h2>
    <div class="mermaid">
flowchart TD
    subgraph AE["After Effects"]
        INPUT[("inputBuffer<br/>(AE GPU World)")]
        OUTPUT[("outputBuffer<br/>(AE GPU World)")]
    end

    subgraph PIPELINE["JustGlow Pipeline"]
        P1["1. Prefilter<br/>13-tap + Threshold"]
        P2["2. Downsample Chain<br/>9-tap Gaussian Ã— N levels"]
        P3["3. Upsample Chain<br/>9-tap + Falloff Blend"]
        P4["4. Composite<br/>DebugOutputKernel"]
    end

    subgraph BUFFERS["GPU ë²„í¼"]
        M0["m_mipChain[0]"]
        M1["m_mipChain[1..N]"]
        U0["m_upsampleChain[0]"]
        UN["m_upsampleChain[N..1]"]
    end

    INPUT -->|"params.inputWidthÃ—inputHeight"| P1
    P1 -->|"threshold, softKnee"| M0
    M0 --> P2
    P2 -->|"2x downsample each"| M1
    M1 --> P3
    P3 -->|"blend levels"| UN
    UN -->|"accumulate"| U0
    U0 -->|"glow texture"| P4
    INPUT -->|"original texture"| P4
    P4 -->|"final composite"| OUTPUT

    style INPUT fill:#2196f3
    style OUTPUT fill:#ff9800
    style M0 fill:#e91e63
    style M1 fill:#e91e63
    style U0 fill:#e91e63
    style UN fill:#e91e63
    </div>

    <h2>2. Stage 1: Prefilter (PrefilterKernel)</h2>
    <div class="mermaid">
flowchart TD
    subgraph INPUT["ì…ë ¥"]
        I1["inputBuffer<br/>(AEì—ì„œ ë°›ì€ GPU ë²„í¼)"]
        I2["params.inputWidth Ã— inputHeight"]
    end

    subgraph OFFSET["ì˜¤í”„ì…‹ ê³„ì‚° âš ï¸"]
        O1["dstWidth = params.width (í™•ì¥ëœ ì¶œë ¥)"]
        O2["offsetX = (dstWidth - inputWidth) / 2"]
        O3["srcX = x - offsetX"]
        O4["UV ê³„ì‚°: u = srcX / inputWidth"]
    end

    subgraph SAMPLE["13-tap ìƒ˜í”Œë§"]
        S1["ZeroPad ìƒ˜í”Œë§<br/>(ê²½ê³„ ë°– = 0)"]
        S2["Weighted Average<br/>Center=4/11, Inner=1/11, ..."]
    end

    subgraph PROCESS["ì²˜ë¦¬"]
        P1["sRGB â†’ Linear<br/>(if linearize)"]
        P2["Soft Threshold<br/>threshold, softKnee"]
        P3["Desaturation<br/>1 - exp(-brightness Ã— 0.5)"]
    end

    subgraph OUTPUT["ì¶œë ¥"]
        O["m_mipChain[0]<br/>width Ã— height"]
    end

    I1 --> O1
    I2 --> O2
    O1 --> O2 --> O3 --> O4
    O4 --> S1 --> S2
    S2 --> P1 --> P2 --> P3
    P3 --> O

    style I1 fill:#2196f3
    style O fill:#e91e63
    style O2 fill:#ff9800
    </div>

    <div class="note">
        <strong>ğŸ“Œ í•µì‹¬:</strong> PrefilterëŠ” <code>inputWidthÃ—inputHeight</code> í¬ê¸°ì˜ ì…ë ¥ì„
        <code>widthÃ—height</code> (í™•ì¥ëœ) í¬ê¸°ì˜ ì¶œë ¥ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.<br/>
        <code>offsetX/Y</code>ë¡œ ì…ë ¥ì„ ì¤‘ì•™ì— ë°°ì¹˜í•˜ê³ , ê²½ê³„ ë°–ì€ ZeroPadë¡œ 0ê°’ ë°˜í™˜.
    </div>

    <h2>3. Stage 2: Downsample Chain</h2>
    <div class="mermaid">
flowchart TD
    subgraph DS["Downsample Loop (i = 0 to mipLevels-2)"]
        D0["m_mipChain[0]<br/>width Ã— height"]
        D1["m_mipChain[1]<br/>width/2 Ã— height/2"]
        D2["m_mipChain[2]<br/>width/4 Ã— height/4"]
        DN["m_mipChain[N-1]<br/>~16 Ã— ~16"]
    end

    subgraph KERNEL["Gaussian2DDownsampleKernel"]
        K1["9-tap 2D Gaussian"]
        K2["ZeroPad ìƒ˜í”Œë§"]
        K3["2x ì¶•ì†Œ"]
    end

    D0 -->|"Gaussian 9-tap"| K1
    K1 --> D1
    D1 --> K1
    K1 --> D2
    D2 -->|"..."| DN

    style D0 fill:#e91e63
    style D1 fill:#e91e63
    style D2 fill:#e91e63
    style DN fill:#e91e63
    </div>

    <h2>4. Stage 3: Upsample Chain (ê°€ì¥ ë³µì¡!) â­</h2>
    <div class="mermaid">
flowchart TD
    subgraph LOOP["Upsample Loop (i = mipLevels-1 down to 0)"]
        direction TB

        subgraph LEVEL_N["Level N-1 (ê°€ì¥ ê¹Šì€ ë ˆë²¨)"]
            LN1["input: m_mipChain[N-1]"]
            LN2["prevLevel: nullptr"]
            LN3["output: m_upsampleChain[N-1]"]
            LN4["ê²°ê³¼ = currLevel Ã— weight"]
        end

        subgraph LEVEL_MID["Level i (ì¤‘ê°„ ë ˆë²¨)"]
            LM1["input: m_mipChain[i]"]
            LM2["prevLevel: m_upsampleChain[i+1]"]
            LM3["output: m_upsampleChain[i]"]
            LM4["ê²°ê³¼ = Upsample(prev) + curr Ã— weight"]
        end

        subgraph LEVEL_0["Level 0 (ìµœì¢…)"]
            L01["input: m_mipChain[0]"]
            L02["prevLevel: m_upsampleChain[1]"]
            L03["output: m_upsampleChain[0]"]
            L04["ìµœì¢… ê¸€ë¡œìš° í…ìŠ¤ì²˜"]
        end
    end

    LN1 --> LN4
    LN4 --> LN3
    LN3 -->|"as prevLevel"| LM2
    LM1 --> LM4
    LM2 -->|"9-tap Upsample"| LM4
    LM4 --> LM3
    LM3 -->|"as prevLevel"| L02
    L01 --> L04
    L02 -->|"9-tap Upsample"| L04
    L04 --> L03

    style LN3 fill:#e91e63
    style LM3 fill:#e91e63
    style L03 fill:#ff9800
    </div>

    <h3>UpsampleKernel ë‚´ë¶€ ë¡œì§</h3>
    <div class="mermaid">
flowchart TD
    subgraph STEP1["STEP 1: Previous Level Upsample"]
        S1A["prevLevel ì¡´ì¬?"]
        S1B["9-tap Gaussian Upsample<br/>Center=4/16, Cross=2/16, Diag=1/16"]
        S1C["resR/G/B = upsampled result"]
        S1D["resR/G/B = 0 (ì²« ë ˆë²¨)"]
    end

    subgraph STEP2["STEP 2: Current Level Contribution"]
        S2A["currMip ìƒ˜í”Œë§"]
        S2B["physicalWeight ê³„ì‚°<br/>calculatePhysicalWeight()"]
        S2C["contrib = curr Ã— physicalWeight"]
    end

    subgraph STEP3["STEP 3: Radius-based Threshold"]
        S3A["levelThreshold = (1-activeLimit) Ã— levelRatio Ã— 0.5"]
        S3B["brightness < threshold?"]
        S3C["contribution = smoothstep curve"]
        S3D["contrib *= contribution"]
    end

    subgraph STEP4["STEP 4: Final Blend"]
        S4A["result = resR + contribR"]
        S4B["output â†’ m_upsampleChain[i]"]
    end

    S1A -->|Yes| S1B --> S1C
    S1A -->|No| S1D
    S1C --> S4A
    S1D --> S4A

    S2A --> S2B --> S2C
    S2C --> S3A --> S3B
    S3B -->|Yes| S3C --> S3D
    S3B -->|No| S3D
    S3D --> S4A
    S4A --> S4B

    style S1C fill:#4caf50
    style S3D fill:#4caf50
    style S4B fill:#ff9800
    </div>

    <h2>5. Stage 4: Composite (DebugOutputKernel)</h2>
    <div class="mermaid">
flowchart TD
    subgraph INPUT["ì…ë ¥ ë²„í¼"]
        I1["original: inputBuffer<br/>(AE ì›ë³¸)"]
        I2["glow: m_upsampleChain[0]<br/>(ê¸€ë¡œìš° ê²°ê³¼)"]
    end

    subgraph OFFSET["ì˜¤í”„ì…‹ ê³„ì‚°"]
        O1["offsetX = (width - inputWidth) / 2"]
        O2["srcX = x - offsetX"]
        O3["bounds check"]
    end

    subgraph SAMPLE_ORIG["ì›ë³¸ ìƒ˜í”Œë§"]
        SO1{srcX, srcY in bounds?}
        SO2["origRGBA = read(original)"]
        SO3["origRGBA = 0,0,0,0"]
        SO4["Linear ë³€í™˜ (if useLinear)"]
    end

    subgraph SAMPLE_GLOW["ê¸€ë¡œìš° ìƒ˜í”Œë§"]
        SG1["u = (x + 0.5) / width"]
        SG2["v = (y + 0.5) / height"]
        SG3{CA enabled?}
        SG4["3-point CA sampling<br/>uR, u, uB"]
        SG5["standard bilinear"]
        SG6["Ã— exposure Ã— glowOpacity"]
    end

    subgraph COMPOSITE["í•©ì„±"]
        C1["srcRGBA Ã— sourceOpacity"]
        C2["glowAlpha = max(glowR,G,B)"]
        C3{compositeMode}
        C4["Add: src + glow"]
        C5["Screen: src + glow - srcÃ—glow"]
        C6["Overlay: conditional"]
        C7["Alpha blend"]
    end

    subgraph OUTPUT["ì¶œë ¥"]
        OUT["outputBuffer"]
    end

    I1 --> O1 --> O2 --> O3 --> SO1
    SO1 -->|Yes| SO2 --> SO4
    SO1 -->|No| SO3
    SO4 --> C1
    SO3 --> C1

    I2 --> SG1 --> SG2 --> SG3
    SG3 -->|Yes| SG4 --> SG6
    SG3 -->|No| SG5 --> SG6
    SG6 --> C2

    C1 --> C3
    C2 --> C3
    C3 -->|Add| C4 --> C7
    C3 -->|Screen| C5 --> C7
    C3 -->|Overlay| C6 --> C7
    C7 --> OUT

    style I1 fill:#2196f3
    style I2 fill:#e91e63
    style OUT fill:#ff9800
    </div>

    <h2>6. ë²„í¼ í¬ê¸° ê´€ê³„</h2>
    <table>
        <tr>
            <th>ë²„í¼</th>
            <th>í¬ê¸°</th>
            <th>ì„¤ëª…</th>
        </tr>
        <tr>
            <td><code>inputBuffer</code></td>
            <td>inputWidth Ã— inputHeight</td>
            <td>AEì—ì„œ ë°›ì€ ì›ë³¸ (í…ìŠ¤íŠ¸ ë ˆì´ì–´: ì‘ìŒ)</td>
        </tr>
        <tr>
            <td><code>outputBuffer</code></td>
            <td>width Ã— height</td>
            <td>AE ì¶œë ¥ (í™•ì¥ëœ í¬ê¸°)</td>
        </tr>
        <tr>
            <td><code>m_mipChain[0]</code></td>
            <td>width Ã— height</td>
            <td>Prefilter ì¶œë ¥ = output í¬ê¸°</td>
        </tr>
        <tr>
            <td><code>m_upsampleChain[0]</code></td>
            <td>width Ã— height</td>
            <td>ìµœì¢… ê¸€ë¡œìš° = output í¬ê¸°</td>
        </tr>
    </table>

    <div class="note">
        <strong>ğŸ“Œ ì¤‘ìš”:</strong> ëª¨ë“  ë‚´ë¶€ ë²„í¼(mipChain, upsampleChain)ëŠ” <code>params.width Ã— height</code>
        (í™•ì¥ëœ ì¶œë ¥ í¬ê¸°) ê¸°ì¤€ìœ¼ë¡œ í• ë‹¹ë©ë‹ˆë‹¤.<br/>
        <code>AllocateMipChain(params.width, params.height, params.mipLevels)</code>
    </div>

    <h2>7. í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì´ìŠˆ ì²´í¬í¬ì¸íŠ¸</h2>
    <div class="mermaid">
flowchart TD
    subgraph CHECK["ğŸ” í™•ì¸ í•„ìš” ì‚¬í•­"]
        C1["1. Prefilter offset ê³„ì‚°<br/>inputWidth vs width"]
        C2["2. MIP chain í¬ê¸°<br/>width ê¸°ì¤€ìœ¼ë¡œ í• ë‹¹?"]
        C3["3. Upsample ê²°ê³¼ í¬ê¸°<br/>m_upsampleChain[0].width == width?"]
        C4["4. Composite glow ìƒ˜í”Œë§<br/>glowWidth == width?"]
        C5["5. AE input_worldP í¬ê¸°<br/>í™•ì¥ ìš”ì²­ì´ ë°˜ì˜ëë‚˜?"]
    end

    C1 --> C2 --> C3 --> C4 --> C5

    style C1 fill:#ff5252
    style C2 fill:#ff5252
    style C3 fill:#ff5252
    style C4 fill:#ff5252
    style C5 fill:#ff5252
    </div>

    <div class="issue">
        <strong>ğŸ” ê°€ì¥ ì˜ì‹¬ë˜ëŠ” ë¶€ë¶„:</strong><br/>
        <ol>
            <li><code>input_worldP->width</code>ê°€ í…ìŠ¤íŠ¸ ë ˆì´ì–´ì—ì„œ í™•ì¥ ì•ˆ ëì„ ê°€ëŠ¥ì„±</li>
            <li>Prefilterì˜ offset ê³„ì‚°ì´ ì‘ì€ inputWidthì—ì„œ ì´ìƒí•˜ê²Œ ì‘ë™</li>
            <li>ê¸€ë¡œìš°ê°€ ìƒì„±ë˜ì§€ë§Œ Compositeì—ì„œ ì˜ëª»ëœ ìœ„ì¹˜ì— í•©ì„±</li>
        </ol>
    </div>

    <h2>íŒŒì¼ ì°¸ì¡°</h2>
    <div class="legend">
        <div class="legend-item"><span class="file">src/JustGlowKernels.cu</span></div>
        <ul>
            <li>PrefilterKernel: Line 343-497</li>
            <li>Gaussian2DDownsampleKernel: Line 506-590</li>
            <li>UpsampleKernel: Line 812-963</li>
            <li>DebugOutputKernel: Line 1059-1350</li>
        </ul>
        <div class="legend-item"><span class="file">src/JustGlowCUDARenderer.cpp</span></div>
        <ul>
            <li>Render(): Line 440-517</li>
            <li>ExecutePrefilter(): Line 523-591</li>
            <li>ExecuteDownsampleChain(): Line 597-650</li>
            <li>ExecuteUpsampleChain(): Line 652-747</li>
            <li>ExecuteComposite(): Line 753-875</li>
        </ul>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
