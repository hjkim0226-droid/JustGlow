<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>JustGlow - Glow Buffer Detail (m_upsampleChain[0])</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', -apple-system, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 40px;
            margin: 0;
        }
        h1 { color: #4fc3f7; text-align: center; }
        h2 {
            color: #81c784;
            margin-top: 40px;
            border-bottom: 2px solid #81c784;
            padding-bottom: 10px;
        }
        h3 { color: #ffb74d; margin-top: 30px; }
        .mermaid {
            background: #252542;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        .code-block {
            background: #1e1e3f;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 15px 0;
        }
        .highlight { color: #4fc3f7; }
        .comment { color: #6a9955; }
        .number { color: #b5cea8; }
        .issue {
            background: rgba(255,82,82,0.2);
            border-left: 4px solid #ff5252;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .note {
            background: rgba(33,150,243,0.2);
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        .success {
            background: rgba(76,175,80,0.2);
            border-left: 4px solid #4caf50;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        th, td {
            border: 1px solid #444;
            padding: 10px;
            text-align: left;
        }
        th { background: #333; }
    </style>
</head>
<body>
    <h1>m_upsampleChain[0] ê¸€ë¡œìš° ë²„í¼ ìƒì„¸</h1>

    <h2>1. ê¸€ë¡œìš° ë²„í¼ ìƒì„± ê³¼ì •</h2>
    <div class="mermaid">
flowchart TD
    subgraph ALLOC["ë²„í¼ í• ë‹¹ (AllocateMipChain)"]
        A1["params.width = output_worldP->width"]
        A2["params.height = output_worldP->height"]
        A3["AllocateMipChain(width, height, mipLevels)"]
        A4["m_upsampleChain[0].width = width<br/>m_upsampleChain[0].height = height"]
    end

    subgraph UPSAMPLE["Upsample Chain ì‹¤í–‰"]
        U1["Level N-1 â†’ m_upsampleChain[N-1]"]
        U2["Level N-2 â†’ m_upsampleChain[N-2]"]
        U3["..."]
        U4["Level 1 â†’ m_upsampleChain[1]"]
        U5["Level 0 â†’ m_upsampleChain[0]"]
    end

    subgraph LEVEL0["Level 0 Upsample ìƒì„¸"]
        L1["input: m_mipChain[0]<br/>(Prefilter ê²°ê³¼)"]
        L2["prevLevel: m_upsampleChain[1]<br/>(Level 1 upsample ê²°ê³¼)"]
        L3["9-tap Gaussian Upsample(prevLevel)"]
        L4["+ currLevel Ã— physicalWeight"]
        L5["output: m_upsampleChain[0]"]
    end

    A1 --> A2 --> A3 --> A4
    A4 --> U1
    U1 --> U2 --> U3 --> U4 --> U5
    U5 --> L1
    L1 --> L4
    L2 --> L3 --> L4
    L4 --> L5

    style A4 fill:#e91e63
    style L5 fill:#ff9800
    </div>

    <h2>2. Compositeì—ì„œ ê¸€ë¡œìš° ìƒ˜í”Œë§</h2>
    <div class="mermaid">
flowchart TD
    subgraph EXEC["ExecuteComposite()"]
        E1["glow = m_upsampleChain[0].devicePtr"]
        E2["glowWidth = m_upsampleChain[0].width"]
        E3["glowHeight = m_upsampleChain[0].height"]
        E4["glowPitch = m_upsampleChain[0].width"]
    end

    subgraph KERNEL["DebugOutputKernel"]
        K1["x, y = ì¶œë ¥ í”½ì…€ ì¢Œí‘œ<br/>(0 ~ width-1, 0 ~ height-1)"]
        K2["u = (x + 0.5) / width"]
        K3["v = (y + 0.5) / height"]
        K4["sampleBilinear(glow, u, v,<br/>glowWidth, glowHeight, glowPitch)"]
    end

    subgraph BILINEAR["sampleBilinear() ë‚´ë¶€"]
        B1["u = clamp(u, 0, 1)"]
        B2["v = clamp(v, 0, 1)"]
        B3["px = u Ã— glowWidth - 0.5"]
        B4["py = v Ã— glowHeight - 0.5"]
        B5["x0 = floor(px), x1 = x0+1"]
        B6["y0 = floor(py), y1 = y0+1"]
        B7["4ê°œ í”½ì…€ bilinear ë³´ê°„"]
    end

    E1 --> E2 --> E3 --> E4
    E4 --> K1
    K1 --> K2 --> K3 --> K4
    K4 --> B1 --> B2 --> B3 --> B4 --> B5 --> B6 --> B7

    style E1 fill:#e91e63
    style K4 fill:#4caf50
    </div>

    <h2>3. UV â†’ í”½ì…€ ì¢Œí‘œ ë³€í™˜ ê³µì‹</h2>

    <div class="code-block">
<span class="comment">// DebugOutputKernelì—ì„œ UV ê³„ì‚°</span>
<span class="highlight">float</span> u = ((<span class="highlight">float</span>)x + <span class="number">0.5f</span>) / (<span class="highlight">float</span>)width;
<span class="highlight">float</span> v = ((<span class="highlight">float</span>)y + <span class="number">0.5f</span>) / (<span class="highlight">float</span>)height;

<span class="comment">// sampleBilinearì—ì„œ í”½ì…€ ì¢Œí‘œ ê³„ì‚°</span>
<span class="highlight">float</span> px = u * (<span class="highlight">float</span>)glowWidth - <span class="number">0.5f</span>;
<span class="highlight">float</span> py = v * (<span class="highlight">float</span>)glowHeight - <span class="number">0.5f</span>;

<span class="comment">// ë§Œì•½ width == glowWidthë¼ë©´:</span>
<span class="comment">// px = ((x + 0.5) / width) Ã— width - 0.5 = x + 0.5 - 0.5 = x</span>
<span class="comment">// â†’ 1:1 ë§¤í•‘ (ì •í™•í•œ í”½ì…€ ëŒ€ì‘)</span>

<span class="comment">// ë§Œì•½ width != glowWidthë¼ë©´:</span>
<span class="comment">// px = ((x + 0.5) / width) Ã— glowWidth - 0.5</span>
<span class="comment">// â†’ ìŠ¤ì¼€ì¼ë§ ë°œìƒ!</span>
    </div>

    <div class="success">
        <strong>âœ… ì •ìƒ ì¼€ì´ìŠ¤ (width == glowWidth):</strong><br/>
        ì¶œë ¥ í”½ì…€ x=100 â†’ u=100.5/width â†’ px=100 â†’ glow í”½ì…€ 100 ìƒ˜í”Œë§<br/>
        <strong>1:1 ëŒ€ì‘</strong>
    </div>

    <div class="issue">
        <strong>âš ï¸ ë¬¸ì œ ì¼€ì´ìŠ¤ (width != glowWidth):</strong><br/>
        ì¶œë ¥ í”½ì…€ x=100, width=470, glowWidth=200 â†’ u=100.5/470=0.214 â†’ px=0.214Ã—200-0.5=42.3<br/>
        <strong>ìŠ¤ì¼€ì¼ë§ ë°œìƒ! ê¸€ë¡œìš°ê°€ ì¶•ì†Œë˜ì–´ ë³´ì„</strong>
    </div>

    <h2>4. ë²„í¼ í¬ê¸° ê²€ì¦ í¬ì¸íŠ¸</h2>
    <div class="mermaid">
flowchart TD
    subgraph CHECK["ğŸ” í™•ì¸ í•„ìš”"]
        C1["params.width == output_worldP->width?"]
        C2["m_upsampleChain[0].width == params.width?"]
        C3["glowWidth == width?"]
    end

    subgraph VALUES["ì‹¤ì œ ê°’ (ë¡œê·¸ì—ì„œ í™•ì¸)"]
        V1["SmartRender DEBUG:<br/>output_world=WxH"]
        V2["Composite DEBUG:<br/>width, glowW"]
        V3["width == glowW ?"]
    end

    C1 --> V1
    C2 --> V2
    C3 --> V3

    style C1 fill:#ff9800
    style C2 fill:#ff9800
    style C3 fill:#ff9800
    </div>

    <h2>5. í…ìŠ¤íŠ¸ ë ˆì´ì–´ ì‹œë‚˜ë¦¬ì˜¤</h2>
    <div class="mermaid">
flowchart LR
    subgraph TEXT["í…ìŠ¤íŠ¸ ë ˆì´ì–´"]
        T1["ì›ë³¸: 200Ã—50"]
        T2["í™•ì¥ ìš”ì²­: +135px"]
        T3["output_worldP: 470Ã—320"]
    end

    subgraph ALLOC2["ë²„í¼ í• ë‹¹"]
        A1["params.width = 470"]
        A2["AllocateMipChain(470, 320, 8)"]
        A3["m_upsampleChain[0] = 470Ã—320"]
    end

    subgraph COMPOSITE2["Composite"]
        C1["width = 470"]
        C2["glowWidth = 470"]
        C3["1:1 ë§¤í•‘ âœ“"]
    end

    T1 --> T2 --> T3
    T3 --> A1 --> A2 --> A3
    A3 --> C2
    T3 --> C1
    C1 --> C3
    C2 --> C3

    style C3 fill:#4caf50
    </div>

    <div class="note">
        <strong>ğŸ“Œ ì´ë¡ ìƒ:</strong> í…ìŠ¤íŠ¸ ë ˆì´ì–´ë„ output_worldPê°€ í™•ì¥ëœ í¬ê¸°(470Ã—320)ë¡œ ì„¤ì •ë˜ë©´,
        ëª¨ë“  ë²„í¼ê°€ ê°™ì€ í¬ê¸°ë¡œ í• ë‹¹ë˜ì–´ 1:1 ë§¤í•‘ì´ ë¨.<br/><br/>
        <strong>í™•ì¸ í•„ìš”:</strong> ë¡œê·¸ì—ì„œ <code>width == glowWidth</code> ì¸ì§€ í™•ì¸!
    </div>

    <h2>6. ì ì¬ì  ë¬¸ì œ ì‹œë‚˜ë¦¬ì˜¤</h2>
    <div class="mermaid">
flowchart TD
    subgraph PROBLEM["âš ï¸ ë§Œì•½ AEê°€ í™•ì¥ì„ ì•ˆ í•´ì¤¬ë‹¤ë©´"]
        P1["input_worldP = 200Ã—50<br/>(í…ìŠ¤íŠ¸ ì›ë³¸ í¬ê¸°)"]
        P2["output_worldP = 200Ã—50<br/>(í™•ì¥ ì•ˆë¨!)"]
        P3["params.width = 200"]
        P4["m_upsampleChain[0] = 200Ã—50"]
    end

    subgraph RESULT["ê²°ê³¼"]
        R1["ê¸€ë¡œìš°ê°€ 200Ã—50 ë²„í¼ì— ìƒì„±"]
        R2["Compositeì—ì„œ 200Ã—50ìœ¼ë¡œ ì¶œë ¥"]
        R3["í™•ì¥ëœ ì˜ì—­ì— ê¸€ë¡œìš° ì•ˆ ë³´ì„!"]
    end

    P1 --> P2 --> P3 --> P4
    P4 --> R1 --> R2 --> R3

    style P2 fill:#ff5252
    style R3 fill:#ff5252
    </div>

    <h2>7. ë””ë²„ê·¸ ë¡œê·¸ì—ì„œ í™•ì¸í•  ê°’</h2>
    <table>
        <tr>
            <th>ë¡œê·¸ í•­ëª©</th>
            <th>ì¡°ì • ë ˆì´ì–´ (ì˜ˆìƒ)</th>
            <th>í…ìŠ¤íŠ¸ ë ˆì´ì–´ (ì˜ˆìƒ)</th>
            <th>í…ìŠ¤íŠ¸ (ë¬¸ì œì‹œ)</th>
        </tr>
        <tr>
            <td>output_world</td>
            <td>2048Ã—1208</td>
            <td>470Ã—320</td>
            <td style="color:#ff5252">200Ã—50</td>
        </tr>
        <tr>
            <td>input_world</td>
            <td>1920Ã—1080</td>
            <td>200Ã—50</td>
            <td>200Ã—50</td>
        </tr>
        <tr>
            <td>width (params)</td>
            <td>2048</td>
            <td>470</td>
            <td style="color:#ff5252">200</td>
        </tr>
        <tr>
            <td>glowW</td>
            <td>2048</td>
            <td>470</td>
            <td style="color:#ff5252">200</td>
        </tr>
        <tr>
            <td>offsetX</td>
            <td>64</td>
            <td>135</td>
            <td style="color:#ff5252">0</td>
        </tr>
    </table>

    <div class="issue">
        <strong>ğŸ” í•µì‹¬ ì²´í¬:</strong><br/>
        <code>offsetX = (width - inputWidth) / 2</code><br/><br/>
        ë§Œì•½ <code>offsetX == 0</code>ì´ë©´, <code>width == inputWidth</code>ì´ë¯€ë¡œ<br/>
        <strong>AEê°€ output_worldPë¥¼ í™•ì¥í•˜ì§€ ì•Šì€ ê²ƒ!</strong>
    </div>

    <h2>8. ì½”ë“œ ìœ„ì¹˜ ì°¸ì¡°</h2>
    <div class="code-block">
<span class="comment">// JustGlowCUDARenderer.cpp - ExecuteComposite()</span>
CUdeviceptr glow = m_upsampleChain[<span class="number">0</span>].devicePtr;  <span class="comment">// Line 765</span>
<span class="highlight">int</span> glowWidth = m_upsampleChain[<span class="number">0</span>].width;       <span class="comment">// Line 766</span>
<span class="highlight">int</span> glowHeight = m_upsampleChain[<span class="number">0</span>].height;     <span class="comment">// Line 767</span>

<span class="comment">// JustGlowKernels.cu - DebugOutputKernel()</span>
<span class="highlight">float</span> u = ((<span class="highlight">float</span>)x + <span class="number">0.5f</span>) / (<span class="highlight">float</span>)width;     <span class="comment">// Line 1118</span>
<span class="highlight">float</span> v = ((<span class="highlight">float</span>)y + <span class="number">0.5f</span>) / (<span class="highlight">float</span>)height;    <span class="comment">// Line 1119</span>
sampleBilinear(glow, u, v, glowWidth, glowHeight, ...);  <span class="comment">// Line 1165</span>

<span class="comment">// JustGlowKernels.cu - sampleBilinear()</span>
<span class="highlight">float</span> px = u * (<span class="highlight">float</span>)width - <span class="number">0.5f</span>;              <span class="comment">// Line 175</span>
<span class="highlight">float</span> py = v * (<span class="highlight">float</span>)height - <span class="number">0.5f</span>;             <span class="comment">// Line 176</span>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
